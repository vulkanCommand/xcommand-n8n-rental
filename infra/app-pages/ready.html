<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>xCommand Cloud — Your Workspace</title>
<meta name="description" content="Your xCommand workspace is being provisioned.">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: hsl(220, 20%, 4%);
    --bg-card: hsl(220, 18%, 7%);
    --fg: hsl(0, 0%, 96%);
    --muted: hsl(220, 10%, 55%);
    --border: hsl(220, 14%, 14%);
    --primary: hsl(180, 70%, 55%);
    --primary-fg: hsl(220, 20%, 4%);
    --secondary: hsl(220, 15%, 12%);
    --surface: hsl(220, 16%, 9%);
    --success: hsl(150, 80%, 55%);
    --warning: hsl(40, 90%, 60%);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--fg);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .grid-bg {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 50;
    padding: 0 2rem;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: hsla(220, 20%, 4%, 0.9);
    backdrop-filter: blur(16px);
  }

  .logo {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--fg);
    text-decoration: none;
  }

  .logo span { color: var(--primary); }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 2rem;
  }

  .nav-links a {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
  }

  .nav-links a:hover { color: var(--fg); }
  .nav-links a.active { color: var(--primary); }

  .container {
    position: relative;
    z-index: 1;
    max-width: 640px;
    margin: 0 auto;
    padding: 120px 1.5rem 80px;
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 2rem;
  }

  .section-label {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--muted);
    margin-bottom: 1rem;
  }

  h1 {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 0.5rem;
  }

  .sub {
    font-size: 0.875rem;
    color: var(--muted);
    margin-bottom: 1.25rem;
    line-height: 1.5;
  }

  /* Status pill */
  .status-row {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    margin-bottom: 1.25rem;
  }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border: 1px solid;
  }

  .pill.provisioning {
    background: hsla(40, 90%, 60%, 0.08);
    border-color: hsla(40, 90%, 60%, 0.4);
    color: var(--warning);
  }

  .pill.active {
    background: hsla(150, 80%, 55%, 0.08);
    border-color: hsla(150, 80%, 55%, 0.4);
    color: var(--success);
  }

  .dot {
    width: 8px;
    height: 8px;
  }

  .pill.provisioning .dot {
    background: var(--warning);
    box-shadow: 0 0 8px var(--warning);
  }

  .pill.active .dot {
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
  }

  .hint {
    font-size: 0.8125rem;
    color: var(--muted);
    margin-bottom: 1.25rem;
    line-height: 1.5;
  }

  /* Email form */
  .email-form {
    margin-top: 0.75rem;
    display: grid;
    gap: 0.5rem;
  }

  .email-form label {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--muted);
  }

  .email-form input {
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--fg);
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.875rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .email-form input:focus { border-color: var(--primary); }

  .primary-btn {
    margin-top: 0.5rem;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--primary);
    background: var(--primary);
    color: var(--primary-fg);
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.1s;
  }

  .primary-btn:hover {
    box-shadow: 0 0 20px -5px hsla(180, 70%, 55%, 0.4);
    transform: translateY(-1px);
  }

  .primary-btn[disabled] {
    opacity: 0.6;
    cursor: wait;
    transform: none;
    box-shadow: none;
  }

  /* Workspace list */
  .workspace-box {
    margin-top: 1.5rem;
    padding: 1rem;
    border: 1px solid var(--border);
    background: var(--surface);
    display: grid;
    gap: 0.75rem;
  }

  .workspace-box .label {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--muted);
  }

  #workspace-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .workspace-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid var(--border);
    background: var(--bg-card);
    font-size: 0.8125rem;
    flex-wrap: wrap;
  }

  .workspace-item-main {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .workspace-item-meta {
    font-size: 0.6875rem;
    color: var(--muted);
  }

  .workspace-item-link {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-decoration: none;
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--primary);
    color: var(--primary);
    transition: all 0.2s;
    white-space: nowrap;
  }

  .workspace-item-link:hover {
    background: var(--primary);
    color: var(--primary-fg);
  }

  .error {
    margin-top: 0.75rem;
    font-size: 0.8125rem;
    color: hsl(0, 80%, 65%);
    min-height: 1.2em;
  }

  .small {
    margin-top: 1rem;
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.5;
  }

  footer {
    position: relative;
    z-index: 1;
    border-top: 1px solid var(--border);
    padding: 2rem;
    text-align: center;
  }

  footer p {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--muted);
  }

  @media (max-width: 768px) {
    header { padding: 0 1rem; }
    .container { padding: 100px 1rem 60px; }
    .nav-links { gap: 1rem; }
    .nav-links a { font-size: 0.6rem; letter-spacing: 0.1em; }
  }

  @media (max-width: 400px) {
    header { padding: 0 0.75rem; height: 56px; }
    .logo { font-size: 1rem; }
    .nav-links { gap: 0.5rem; }
    .nav-links a { font-size: 0.5rem; letter-spacing: 0.06em; }
    .container { padding: 76px 0.75rem 40px; }
    .card { padding: 1.25rem; }
    h1 { font-size: 1.35rem; }
    .workspace-item { flex-direction: column; align-items: flex-start; }
    .workspace-item-link { align-self: stretch; text-align: center; }
  }
</style>
</head>
<body>

<div class="grid-bg"></div>

<header>
  <a href="https://xcommand.cloud" class="logo">xCommand<span>.</span></a>
  <nav class="nav-links">
    <a href="https://xcommand.cloud/">Home</a>
    <a href="https://xcommand.cloud/pay.html">Plans</a>
    <a href="https://xcommand.cloud/ready.html" class="active">Workspace</a>
    <a href="https://app.xcommand.cloud/support">Support</a>
  </nav>
</header>

<div class="container">
  <div class="card">
    <p class="section-label">Workspace Status</p>
    <h1>Your n8n workspace is getting ready</h1>
    <p class="sub">Payment was successful. We're provisioning an isolated n8n container for you.</p>

    <div class="status-row">
      <div id="status-pill" class="pill provisioning">
        <span class="dot"></span>
        <span id="status-text">Provisioning workspace…</span>
      </div>
    </div>

    <p class="hint" id="hint-text">This usually takes under a minute. We'll keep checking for your workspace and show a button when it's ready.</p>

    <div class="email-form" id="email-form">
      <label for="email-input">Email you used during checkout</label>
      <input id="email-input" type="email" placeholder="you@example.com" />
      <button id="start-btn" class="primary-btn">Find my workspace</button>
    </div>

    <div class="workspace-box" id="workspace-box" style="display:none;">
      <div class="label">Your workspaces</div>
      <div id="workspace-info" class="small" style="margin-top:0;"></div>
      <div id="workspace-list"></div>
    </div>

    <div class="error" id="error-text"></div>

    <p class="small">
      Tip: keep this page open while we provision. If you don't see anything after a few minutes,
      double-check the email you used at checkout.
    </p>
  </div>
</div>

<footer>
  <p>&copy; 2025 xCommand Cloud. All rights reserved.</p>
</footer>

<script>
const API_BASE = "https://api.app.xcommand.cloud";

const emailInput    = document.getElementById("email-input");
const startBtn      = document.getElementById("start-btn");
const errorText     = document.getElementById("error-text");
const statusPill    = document.getElementById("status-pill");
const statusText    = document.getElementById("status-text");
const hintText      = document.getElementById("hint-text");
const workspaceBox  = document.getElementById("workspace-box");
const workspaceInfo = document.getElementById("workspace-info");
const workspaceList = document.getElementById("workspace-list");

let pollTimer = null;

function setStatus(state) {
  statusPill.classList.remove("provisioning", "active");
  if (state === "active") {
    statusPill.classList.add("active");
    statusText.textContent = "Workspace is live";
    hintText.textContent = "You can open your n8n UI in a new tab. Keep this link handy.";
  } else {
    statusPill.classList.add("provisioning");
    statusText.textContent = "Provisioning workspace…";
    hintText.textContent = "This usually takes under a minute. We're checking for your workspace.";
  }
}

function setLoading(isLoading) {
  startBtn.disabled = isLoading;
  startBtn.textContent = isLoading ? "Looking up workspace…" : "Find my workspace";
}

async function fetchWorkspaces(email) {
  const url = `${API_BASE}/workspaces/all-by-email/${encodeURIComponent(email)}`;
  const res = await fetch(url);
  if (res.status === 404) return [];
  if (!res.ok) throw new Error(`API error ${res.status}`);
  const data = await res.json();
  if (!data.ok) return [];
  return data.workspaces || [];
}

async function poll(email) {
  try {
    const workspaces = await fetchWorkspaces(email);
    if (!workspaces.length) {
      setStatus("provisioning");
      workspaceBox.style.display = "none";
      workspaceInfo.textContent = "";
      workspaceList.innerHTML = "";
      errorText.textContent = "No workspace found for this email. Make sure you used the same email at checkout.";
      return;
    }

    errorText.textContent = "";
    const hasActive = workspaces.some(ws => ws.status === "active");
    setStatus(hasActive ? "active" : "provisioning");
    workspaceBox.style.display = "grid";
    workspaceInfo.textContent = workspaces.length === 1
      ? "We found 1 workspace for this email."
      : `We found ${workspaces.length} workspaces for this email.`;

    workspaceList.innerHTML = "";

    for (const ws of workspaces) {
      const row = document.createElement("div");
      row.className = "workspace-item";

      const main = document.createElement("div");
      main.className = "workspace-item-main";

      const title = document.createElement("div");
      const fqdn = ws.fqdn || `${ws.subdomain}.xcommand.cloud`;
      title.textContent = fqdn;

      const meta = document.createElement("div");
      meta.className = "workspace-item-meta";
      meta.textContent = [
        ws.plan ? `Plan: ${ws.plan}` : null,
        ws.status ? `Status: ${ws.status}` : null,
        ws.expires_at ? `Expires: ${ws.expires_at}` : null,
      ].filter(Boolean).join(" · ");

      main.appendChild(title);
      main.appendChild(meta);

      const link = document.createElement("a");
      link.className = "workspace-item-link";
      link.href = fqdn.startsWith("http") ? fqdn : `https://${fqdn}`;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = ws.status === "active" ? "Open →" : "Not ready";

      if (ws.status !== "active") {
        link.style.opacity = "0.4";
        link.style.pointerEvents = "none";
      }

      row.appendChild(main);
      row.appendChild(link);
      workspaceList.appendChild(row);
    }

    if (hasActive && pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  } catch (err) {
    console.error(err);
    workspaceBox.style.display = "none";
    workspaceInfo.textContent = "";
    workspaceList.innerHTML = "";
    errorText.textContent = "Could not reach the API. Please try again in a moment.";
  }
}

function startPolling(email) {
  if (pollTimer) clearInterval(pollTimer);
  poll(email);
  pollTimer = setInterval(() => poll(email), 5000);
}

try {
  const storedEmail = localStorage.getItem("x_email");
  if (storedEmail) {
    emailInput.value = storedEmail;
    startPolling(storedEmail);
  }
} catch (e) { console.warn("no localStorage", e); }

startBtn.addEventListener("click", () => {
  const email = emailInput.value.trim();
  if (!email) { errorText.textContent = "Please enter the email you used at checkout."; emailInput.focus(); return; }
  try { localStorage.setItem("x_email", email); } catch (e) {}
  errorText.textContent = "";
  workspaceInfo.textContent = "";
  workspaceList.innerHTML = "";
  workspaceBox.style.display = "none";
  setStatus("provisioning");
  setLoading(true);
  startPolling(email);
  setTimeout(() => setLoading(false), 1200);
});
</script>
</body>
</html>